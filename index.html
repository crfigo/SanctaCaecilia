<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sancta Caecilia</title>
    <!-- Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para procesar los archivos CSV de Google Sheets de forma segura -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Choices.js para dropdowns con búsqueda y selección múltiple -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <style>
        /* Estilos personalizados para la aplicación */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para la pestaña activa */
        .tab-active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .pagination-button {
            min-width: 40px;
        }
        /* Ocultar las flechas en los inputs de tipo número */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        
        /* Estilos para Choices.js con alto contraste */
        .choices {
            background-color: #e5e7eb; /* gray-200 */
        }
        .choices__inner {
            background-color: #e5e7eb; /* gray-200 */
            border-color: #9ca3af; /* gray-400 */
            color: #1e3a8a; /* blue-900 - Texto azul oscuro */
            min-height: 42px; /* Altura consistente */
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            border-radius: 0.375rem; /* rounded-md */
            border-width: 1px;
        }
        .choices.is-focused .choices__inner {
            border-color: #3b82f6 !important; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .choices__list--dropdown {
            background-color: #f9fafb; /* gray-50 */
            border-color: #d1d5db; /* gray-300 */
        }
        .choices__item--choice {
            color: #1e3a8a; /* blue-900 */
        }
        .choices__item--selectable.is-highlighted {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .choices__input {
             background-color: transparent;
             color: #1e3a8a; /* blue-900 */
        }
        .choices__item--selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }

        /* Tabla responsiva para móviles */
        @media screen and (max-width: 767px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody, .responsive-table tr, .responsive-table td {
                display: block;
                width: 100%;
            }
            .responsive-table tr {
                margin-bottom: 1.5rem;
                border: 1px solid #4b5563; /* gray-600 */
                border-radius: 0.5rem; /* rounded-lg */
                overflow: hidden;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                text-align: right;
                border-bottom: 1px solid #374151; /* gray-700 */
            }
            .responsive-table td:last-child {
                border-bottom: 0;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #9ca3af; /* gray-400 */
                text-align: left;
                margin-right: 1rem;
            }
            /* Celda de Artista como cabecera de la tarjeta */
            .responsive-table td:first-child {
                background-color: #374151; /* gray-700 */
                color: white;
                font-weight: 700;
                font-size: 1.125rem; /* text-lg */
                justify-content: center;
            }
            .responsive-table td:first-child::before {
                display: none;
            }
            .responsive-table td[data-label="Links"] .flex {
                justify-content: flex-end;
                flex-grow: 1;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="loading-indicator" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg">Cargando datos desde Google Sheets...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Sancta Caecilia</h1>
            <p class="text-gray-400 mt-2">by LFR</p>
        </header>

        <!-- Navegación de Pestañas -->
        <nav class="flex flex-wrap justify-center gap-2 mb-8">
            <button onclick="showTab('por-escuchar-list')" class="tab-button tab-active py-2 px-4 rounded-md font-semibold bg-gray-700 hover:bg-blue-600 transition-colors duration-200 flex items-center">
                Para Escuchar (Lista) <span id="count-pe" class="ml-2 bg-blue-600 text-xs font-semibold px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="showTab('escuchadas-list')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-700 hover:bg-blue-600 transition-colors duration-200 flex items-center">
                Escuchadas (Lista) <span id="count-e" class="ml-2 bg-blue-600 text-xs font-semibold px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="showTab('por-escuchar-random')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-700 hover:bg-blue-600 transition-colors duration-200">Para Escuchar (Random)</button>
            <button onclick="showTab('escuchadas-random')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-700 hover:bg-blue-600 transition-colors duration-200">Escuchadas (Random)</button>
        </nav>

        <!-- Contenido de las Pestañas -->
        <main>
            <!-- Pestaña 1: Para Escuchar - Lista -->
            <div id="por-escuchar-list" class="tab-content">
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4">Filtros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                        <div class="flex flex-col">
                            <label for="filter-pe-artista" class="text-sm font-medium text-gray-400 mb-1">Artista</label>
                            <input type="text" id="filter-pe-artista" placeholder="Artista..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-disco" class="text-sm font-medium text-gray-400 mb-1">Disco</label>
                            <input type="text" id="filter-pe-disco" placeholder="Disco..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-estilo" class="text-sm font-medium text-gray-400 mb-1">Estilo(s)</label>
                            <select id="filter-pe-estilo" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-pais" class="text-sm font-medium text-gray-400 mb-1">País(es)</label>
                            <select id="filter-pe-pais" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-escuchada" class="text-sm font-medium text-gray-400 mb-1">Ya Escuchada?</label>
                            <select id="filter-pe-escuchada" multiple></select>
                        </div>
                    </div>
                    <div class="flex items-center justify-end mt-4">
                        <button onclick="shuffleList('porEscuchar')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Shuffle Orden</button>
                    </div>
                </div>
                <div class="overflow-x-auto bg-gray-800 rounded-lg">
                    <table class="min-w-full text-sm text-left text-gray-300 responsive-table">
                        <thead class="text-xs text-gray-100 uppercase bg-gray-700">
                            <tr>
                                <th class="px-6 py-3">Artista</th>
                                <th class="px-6 py-3">Disco</th>
                                <th class="px-6 py-3">Estilo</th>
                                <th class="px-6 py-3">País</th>
                                <th class="px-6 py-3">Comentario</th>
                                <th class="px-6 py-3">Ya Escuchada?</th>
                                <th class="px-6 py-3">Links</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-por-escuchar"></tbody>
                    </table>
                </div>
                <div id="pagination-pe" class="flex flex-wrap justify-center items-center mt-4 gap-2"></div>
            </div>

            <!-- Pestaña 2: Escuchadas - Lista -->
            <div id="escuchadas-list" class="tab-content" style="display: none;">
                <div class="bg-gray-800 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4">Filtros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col">
                            <label for="filter-e-artista" class="text-sm font-medium text-gray-400 mb-1">Artista</label>
                            <input type="text" id="filter-e-artista" placeholder="Artista..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-e-estilo" class="text-sm font-medium text-gray-400 mb-1">Estilo(s)</label>
                            <select id="filter-e-estilo" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-e-pais" class="text-sm font-medium text-gray-400 mb-1">País(es)</label>
                            <select id="filter-e-pais" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-e-seguir" class="text-sm font-medium text-gray-400 mb-1">Seguir Escuchando?</label>
                            <select id="filter-e-seguir" multiple></select>
                        </div>
                    </div>
                     <div class="flex items-center justify-end mt-4">
                        <button onclick="shuffleList('escuchadas')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Shuffle Orden</button>
                    </div>
                </div>
                <div class="overflow-x-auto bg-gray-800 rounded-lg">
                    <table class="min-w-full text-sm text-left text-gray-300 responsive-table">
                        <thead class="text-xs text-gray-100 uppercase bg-gray-700">
                            <tr>
                                <th class="px-6 py-3">Artista</th>
                                <th class="px-6 py-3">Estilo</th>
                                <th class="px-6 py-3">País</th>
                                <th class="px-6 py-3">Comentario</th>
                                <th class="px-6 py-3">Seguir Escuchando?</th>
                                <th class="px-6 py-3">Links</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-escuchadas"></tbody>
                    </table>
                </div>
                 <div id="pagination-e" class="flex flex-wrap justify-center items-center mt-4 gap-2"></div>
            </div>

            <!-- Pestaña 3: Para Escuchar - Random -->
            <div id="por-escuchar-random" class="tab-content text-center" style="display: none;">
                <button onclick="showRandom('porEscuchar')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors mb-8">¡Dame un artista para escuchar!</button>
                <div id="random-card-por-escuchar" class="bg-gray-800 rounded-lg p-6 max-w-2xl mx-auto shadow-lg">
                     <p class="text-gray-400">Haz clic en el botón para obtener una recomendación aleatoria.</p>
                </div>
            </div>

            <!-- Pestaña 4: Escuchadas - Random -->
            <div id="escuchadas-random" class="tab-content text-center" style="display: none;">
                <button onclick="showRandom('escuchadas')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors mb-8">¡Recuérdame un artista que ya escuché!</button>
                <div id="random-card-escuchadas" class="bg-gray-800 rounded-lg p-6 max-w-2xl mx-auto shadow-lg">
                    <p class="text-gray-400">Haz clic en el botón para obtener un recuerdo aleatorio.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URLs de los Google Sheets publicados como CSV
        const URL_POR_ESCUCHAR = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGpNMHvwKugDUe7EvNvQVIBEBg7RdgHEpcWlUuOQlE5oBF0b61Ql-HN35dWfewWlR7gftloGshufJ-/pub?gid=0&single=true&output=csv';
        const URL_ESCUCHADAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGpNMHvwKugDUe7EvNvQVIBEBg7RdgHEpcWlUuOQlE5oBF0b61Ql-HN35dWfewWlR7gftloGshufJ-/pub?gid=832295915&single=true&output=csv';

        // Almacenamiento de datos
        let porEscucharData = [];
        let escuchadasData = [];
        let filteredPorEscuchar = [];
        let filteredEscuchadas = [];
        
        // Instancias de Choices.js
        let choicesPE = {};
        let choicesE = {};

        // Paginación
        let porEscucharCurrentPage = 1;
        let escuchadasCurrentPage = 1;
        const ROWS_PER_PAGE = 10;

        // Nombres de los servicios para los links
        const LINK_NAMES = ["Spotify", "Metal Archives", "RYM", "LastFM", "AOTY", "Music Map", "AllMusic", "Google"];

        // --- INICIALIZACIÓN ---
        window.onload = async () => {
            try {
                const [peData, eData] = await Promise.all([
                    fetchAndParseCSV(URL_POR_ESCUCHAR),
                    fetchAndParseCSV(URL_ESCUCHADAS)
                ]);
                
                porEscucharData = peData.slice(5).filter(row => row[1]);
                escuchadasData = eData.slice(5).filter(row => row[1]);
                
                filteredPorEscuchar = [...porEscucharData];
                filteredEscuchadas = [...escuchadasData];
                
                updateTabCounts();
                initializeFilters();
                renderTable('porEscuchar');
                renderTable('escuchadas');

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                alert("Hubo un error al cargar los datos desde Google Sheets. Revisa la consola para más detalles.");
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
            }
        };

        // --- LÓGICA DE DATOS Y FILTROS ---
        async function fetchAndParseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false,
                    complete: (results) => {
                        const cleanData = results.data.filter(row => row.some(cell => cell && cell.trim() !== ''));
                        resolve(cleanData);
                    },
                    error: (error) => reject(error)
                });
            });
        }

        function initializeFilters() {
            // Configuración común para Choices.js
            const choicesConfig = (placeholder) => ({
                removeItemButton: true,
                placeholder: true,
                placeholderValue: placeholder,
                classNames: { containerOuter: 'choices' }
            });

            // --- Filtros "Para Escuchar" ---
            const peEstilos = [...new Set(porEscucharData.map(row => row[3]).filter(Boolean))].sort().map(val => ({value: val, label: val}));
            const pePaises = [...new Set(porEscucharData.map(row => row[4]).filter(Boolean))].sort().map(val => ({value: val, label: val}));
            const peEscuchadaOpts = [{value: 'SI', label: 'Sí'}, {value: 'NO', label: 'No'}];

            choicesPE.estilo = new Choices('#filter-pe-estilo', choicesConfig(''));
            choicesPE.estilo.setChoices(peEstilos, 'value', 'label', false);
            
            choicesPE.pais = new Choices('#filter-pe-pais', choicesConfig(''));
            choicesPE.pais.setChoices(pePaises, 'value', 'label', false);

            choicesPE.escuchada = new Choices('#filter-pe-escuchada', choicesConfig(''));
            choicesPE.escuchada.setChoices(peEscuchadaOpts, 'value', 'label', false);
            
            // Event Listeners para filtros automáticos
            document.getElementById('filter-pe-artista').addEventListener('input', () => applyFilters('porEscuchar'));
            document.getElementById('filter-pe-disco').addEventListener('input', () => applyFilters('porEscuchar'));
            document.getElementById('filter-pe-estilo').addEventListener('change', () => applyFilters('porEscuchar'));
            document.getElementById('filter-pe-pais').addEventListener('change', () => applyFilters('porEscuchar'));
            document.getElementById('filter-pe-escuchada').addEventListener('change', () => applyFilters('porEscuchar'));

            // --- Filtros "Escuchadas" ---
            const eEstilos = [...new Set(escuchadasData.map(row => row[2]).filter(Boolean))].sort().map(val => ({value: val, label: val}));
            const ePaises = [...new Set(escuchadasData.map(row => row[3]).filter(Boolean))].sort().map(val => ({value: val, label: val}));
            const eSeguirOpts = [{value: 'SI', label: 'Sí'}, {value: 'NO', label: 'No'}];

            choicesE.estilo = new Choices('#filter-e-estilo', choicesConfig(''));
            choicesE.estilo.setChoices(eEstilos, 'value', 'label', false);

            choicesE.pais = new Choices('#filter-e-pais', choicesConfig(''));
            choicesE.pais.setChoices(ePaises, 'value', 'label', false);

            choicesE.seguir = new Choices('#filter-e-seguir', choicesConfig(''));
            choicesE.seguir.setChoices(eSeguirOpts, 'value', 'label', false);
            
            // Event Listeners para filtros automáticos
            document.getElementById('filter-e-artista').addEventListener('input', () => applyFilters('escuchadas'));
            document.getElementById('filter-e-estilo').addEventListener('change', () => applyFilters('escuchadas'));
            document.getElementById('filter-e-pais').addEventListener('change', () => applyFilters('escuchadas'));
            document.getElementById('filter-e-seguir').addEventListener('change', () => applyFilters('escuchadas'));
        }

        function applyFilters(type) {
            if (type === 'porEscuchar') {
                const artista = document.getElementById('filter-pe-artista').value.toLowerCase();
                const disco = document.getElementById('filter-pe-disco').value.toLowerCase();
                const estilos = choicesPE.estilo.getValue(true);
                const paises = choicesPE.pais.getValue(true);
                const escuchadas = choicesPE.escuchada.getValue(true);

                filteredPorEscuchar = porEscucharData.filter(row => {
                    const matchArtista = (row[1] || '').toLowerCase().includes(artista);
                    const matchDisco = (row[2] || '').toLowerCase().includes(disco);
                    const matchEstilo = estilos.length === 0 || estilos.includes(row[3] || '');
                    const matchPais = paises.length === 0 || paises.includes(row[4] || '');
                    const matchEscuchada = escuchadas.length === 0 || escuchadas.includes(row[6] || '');
                    return matchArtista && matchDisco && matchEstilo && matchPais && matchEscuchada;
                });
                porEscucharCurrentPage = 1;
                renderTable('porEscuchar');
            } else {
                const artista = document.getElementById('filter-e-artista').value.toLowerCase();
                const estilos = choicesE.estilo.getValue(true);
                const paises = choicesE.pais.getValue(true);
                const seguir = choicesE.seguir.getValue(true);

                filteredEscuchadas = escuchadasData.filter(row => {
                    const matchArtista = (row[1] || '').toLowerCase().includes(artista);
                    const matchEstilo = estilos.length === 0 || estilos.includes(row[2] || '');
                    const matchPais = paises.length === 0 || paises.includes(row[3] || '');
                    const matchSeguir = seguir.length === 0 || seguir.includes(row[5] || '');
                    return matchArtista && matchEstilo && matchPais && matchSeguir;
                });
                escuchadasCurrentPage = 1;
                renderTable('escuchadas');
            }
        }

        // --- LÓGICA DE LA INTERFAZ (UI) ---
        function updateTabCounts() {
            document.getElementById('count-pe').textContent = porEscucharData.length;
            document.getElementById('count-e').textContent = escuchadasData.length;
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('tab-active'));
            document.getElementById(tabId).style.display = 'block';
            const activeButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.getAttribute('onclick') === `showTab('${tabId}')`);
            if (activeButton) activeButton.classList.add('tab-active');
        }

        function renderTable(type) {
            const tableBodyId = type === 'porEscuchar' ? 'table-body-por-escuchar' : 'table-body-escuchadas';
            const tableBody = document.getElementById(tableBodyId);
            const data = type === 'porEscuchar' ? filteredPorEscuchar : filteredEscuchadas;
            const currentPage = type === 'porEscuchar' ? porEscucharCurrentPage : escuchadasCurrentPage;

            tableBody.innerHTML = ''; 

            if (!data || data.length === 0) {
                const colSpan = type === 'porEscuchar' ? 7 : 6;
                tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4">No se encontraron resultados para los filtros aplicados.</td></tr>`;
                renderPaginationControls(type);
                return;
            }
            
            const startIndex = (currentPage - 1) * ROWS_PER_PAGE;
            const endIndex = startIndex + ROWS_PER_PAGE;
            const paginatedData = data.slice(startIndex, endIndex);

            paginatedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'bg-gray-800 border-b border-gray-700';

                if (type === 'porEscuchar') {
                    const linksHtml = generateLinksHtml(row, 7, 14);
                    tr.innerHTML = `
                        <td data-label="Artista" class="px-6 py-2 font-medium text-white whitespace-nowrap">${row[1] || ''}</td>
                        <td data-label="Disco" class="px-6 py-2">${row[2] || ''}</td>
                        <td data-label="Estilo" class="px-6 py-2">${row[3] || ''}</td>
                        <td data-label="País" class="px-6 py-2">${row[4] || ''}</td>
                        <td data-label="Comentario" class="px-6 py-2">${row[5] || ''}</td>
                        <td data-label="Ya Escuchada?" class="px-6 py-2">${row[6] || ''}</td>
                        <td data-label="Links" class="px-6 py-2">${linksHtml}</td>
                    `;
                } else {
                    const linksHtml = generateLinksHtml(row, 6, 13);
                    tr.innerHTML = `
                        <td data-label="Artista" class="px-6 py-2 font-medium text-white whitespace-nowrap">${row[1] || ''}</td>
                        <td data-label="Estilo" class="px-6 py-2">${row[2] || ''}</td>
                        <td data-label="País" class="px-6 py-2">${row[3] || ''}</td>
                        <td data-label="Comentario" class="px-6 py-2">${row[4] || ''}</td>
                        <td data-label="Seguir Escuchando?" class="px-6 py-2">${row[5] || ''}</td>
                        <td data-label="Links" class="px-6 py-2">${linksHtml}</td>
                    `;
                }
                tableBody.appendChild(tr);
            });
            renderPaginationControls(type);
        }
        
        function renderPaginationControls(type) {
            const containerId = type === 'porEscuchar' ? 'pagination-pe' : 'pagination-e';
            const container = document.getElementById(containerId);
            const data = type === 'porEscuchar' ? filteredPorEscuchar : filteredEscuchadas;
            let currentPage = type === 'porEscuchar' ? porEscucharCurrentPage : escuchadasCurrentPage;
            const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);

            container.innerHTML = '';
            if (totalPages <= 1) return;
            
            const btnClass = "pagination-button px-3 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed";

            let html = `<div class="flex items-center justify-center gap-2">`;
            html += `<button onclick="changePage('${type}', 1)" class="${btnClass}" ${currentPage === 1 ? 'disabled' : ''}>Inicio</button>`;
            html += `<button onclick="changePage('${type}', ${currentPage - 1})" class="${btnClass}" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>`;
            html += `<span class="text-sm text-gray-400">Página</span>`;
            html += `<input type="number" value="${currentPage}" onchange="goToPage('${type}', this.value, ${totalPages})" min="1" max="${totalPages}" class="w-16 bg-gray-600 text-center rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">`;
            html += `<span class="text-sm text-gray-400">de ${totalPages}</span>`;
            html += `<button onclick="changePage('${type}', ${currentPage + 1})" class="${btnClass}" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente</button>`;
            html += `<button onclick="changePage('${type}', ${totalPages})" class="${btnClass}" ${currentPage === totalPages ? 'disabled' : ''}>Final</button>`;
            html += `</div>`;

            container.innerHTML = html;
        }

        function changePage(type, page) {
            const data = type === 'porEscuchar' ? filteredPorEscuchar : filteredEscuchadas;
            const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);
            const newPage = Math.max(1, Math.min(page, totalPages));

            if (type === 'porEscuchar') {
                porEscucharCurrentPage = newPage;
            } else {
                escuchadasCurrentPage = newPage;
            }
            renderTable(type);
        }
        
        function goToPage(type, pageStr, totalPages) {
            let page = parseInt(pageStr, 10);
            if (isNaN(page) || page < 1) {
                page = 1;
            } else if (page > totalPages) {
                page = totalPages;
            }
            changePage(type, page);
        }

        function generateLinksHtml(row, startIdx, endIdx) {
            let linksHtml = '<div class="flex flex-wrap gap-2">';
            for (let i = startIdx; i <= endIdx; i++) {
                const url = row[i];
                const name = LINK_NAMES[i - startIdx];
                if (url && url.startsWith('http')) {
                    let finalUrl = url;
                    let target = '_blank';
                    
                    // Specific logic for Spotify to open the desktop app
                    if (name === "Spotify" && url.includes('open.spotify.com')) {
                        finalUrl = url.replace('https://open.spotify.com/', 'spotify:');
                        target = '_self'; // URI schemes don't need a new tab
                    }

                    linksHtml += `<a href="${finalUrl}" target="${target}" rel="noopener noreferrer" class="text-xs bg-blue-800 hover:bg-blue-700 text-white font-semibold py-1 px-2 rounded-full transition-colors">${name}</a>`;
                }
            }
            linksHtml += '</div>';
            return linksHtml;
        }
        
        function shuffleList(type) {
            if (type === 'porEscuchar') {
                for (let i = filteredPorEscuchar.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [filteredPorEscuchar[i], filteredPorEscuchar[j]] = [filteredPorEscuchar[j], filteredPorEscuchar[i]];
                }
                porEscucharCurrentPage = 1;
            } else {
                 for (let i = filteredEscuchadas.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [filteredEscuchadas[i], filteredEscuchadas[j]] = [filteredEscuchadas[j], filteredEscuchadas[i]];
                }
                escuchadasCurrentPage = 1;
            }
            renderTable(type);
        }

        // --- LÓGICA RANDOM (TABS 3 Y 4) ---
        function showRandom(type) {
            const data = type === 'porEscuchar' ? porEscucharData : escuchadasData;
            const cardContainerId = type === 'porEscuchar' ? 'random-card-por-escuchar' : 'random-card-escuchadas';
            const cardContainer = document.getElementById(cardContainerId);

            if (!data || data.length === 0) {
                cardContainer.innerHTML = '<p class="text-red-400">No hay datos disponibles para mostrar.</p>';
                return;
            }

            const randomIndex = Math.floor(Math.random() * data.length);
            const randomRow = data[randomIndex];
            
            cardContainer.innerHTML = ''; 
            
            let cardHtml = '';
            if (type === 'porEscuchar') {
                const linksHtml = generateLinksHtml(randomRow, 7, 14);
                cardHtml = `
                    <h2 class="text-3xl font-bold text-blue-400 mb-2">${randomRow[1] || 'Sin Artista'}</h2>
                    <p class="text-xl text-white mb-4">${randomRow[2] || 'Sin Disco'}</p>
                    <div class="text-left space-y-2">
                        <p><strong class="font-semibold text-gray-400 w-24 inline-block">Estilo:</strong> ${randomRow[3] || 'N/A'}</p>
                        <p><strong class="font-semibold text-gray-400 w-24 inline-block">País:</strong> ${randomRow[4] || 'N/A'}</p>
                        <p><strong class="font-semibold text-gray-400 w-24 inline-block">Comentario:</strong> ${randomRow[5] || 'N/A'}</p>
                        <p><strong class="font-semibold text-gray-400 w-24 inline-block">Escuchada?:</strong> ${randomRow[6] || 'N/A'}</p>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-semibold text-lg mb-3">Enlaces</h4>
                        ${linksHtml}
                    </div>
                `;
            } else {
                const linksHtml = generateLinksHtml(randomRow, 6, 13);
                cardHtml = `
                    <h2 class="text-3xl font-bold text-blue-400 mb-2">${randomRow[1] || 'Sin Artista'}</h2>
                    <div class="text-left space-y-2">
                        <p><strong class="font-semibold text-gray-400 w-32 inline-block">Estilo:</strong> ${randomRow[2] || 'N/A'}</p>
                        <p><strong class="font-semibold text-gray-400 w-32 inline-block">País:</strong> ${randomRow[3] || 'N/A'}</p>
                        <p><strong class="font-semibold text-gray-400 w-32 inline-block">Comentario:</strong> ${randomRow[4] || 'N/A'}</p>
                        <p><strong class="font-semibold text-gray-400 w-32 inline-block">Seguir Escuchando?:</strong> ${randomRow[5] || 'N/A'}</p>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-semibold text-lg mb-3">Enlaces</h4>
                        ${linksHtml}
                    </div>
                `;
            }
            cardContainer.innerHTML = cardHtml;
        }
    </script>
</body>
</html>
