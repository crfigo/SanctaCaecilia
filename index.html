<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sancta Caecilia</title>
    <link rel="icon" href="http://googleusercontent.com/file_content/1" type="image/webp">
    <!-- Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para procesar los archivos CSV de Google Sheets de forma segura -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Tom Select para dropdowns con búsqueda y selección múltiple -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <!-- Chart.js para los gráficos de estadísticas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos personalizados para la aplicación */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        /* Estilo para la pestaña activa */
        .tab-active {
            background-color: #4b5563; /* gray-600 */
            color: white;
        }
        .pagination-button {
            min-width: 40px;
        }
        /* Ocultar las flechas en los inputs de tipo número */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        
        /* Estilos para Tom Select */
        .ts-wrapper .ts-control {
            background-color: #e5e7eb; /* gray-200 */
            border-color: #9ca3af; /* gray-400 */
            min-height: 42px;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
        }
        .ts-wrapper.focus .ts-control {
            border-color: #6b7280 !important;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.5);
        }
        .ts-wrapper .ts-control > input {
            color: #1f2937; /* gray-800 */
        }
        .ts-wrapper .ts-control .ts-item {
            background-color: #4b5563; /* gray-600 */
            color: white;
        }
        .ts-wrapper .ts-dropdown {
            background-color: #f9fafb; /* gray-50 */
            border-color: #d1d5db; /* gray-300 */
        }
        .ts-wrapper .ts-dropdown .ts-option {
            color: #1f2937; /* gray-800 */
        }
        .ts-wrapper .ts-dropdown .ts-option.active {
            background-color: #bae6fd; /* Celeste (sky-200) */
            color: #1f2937; /* Texto oscuro para contraste */
        }

        /* Tabla responsiva para móviles */
        @media screen and (max-width: 767px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody, .responsive-table tr, .responsive-table td {
                display: block;
                width: 100%;
            }
            .responsive-table tr {
                margin-bottom: 1.5rem;
                border: 1px solid #4b5563; /* gray-600 */
                border-radius: 0.5rem; /* rounded-lg */
                overflow: hidden;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                text-align: right;
                border-bottom: 1px solid #374151; /* gray-700 */
            }
            .responsive-table td:last-child {
                border-bottom: 0;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #9ca3af; /* gray-400 */
                text-align: left;
                margin-right: 1rem;
            }
            /* Celda de Artista como cabecera de la tarjeta */
            .responsive-table td:first-child {
                background-color: #374151; /* gray-700 */
                color: white;
                font-weight: 700;
                font-size: 1.125rem; /* text-lg */
                justify-content: center;
            }
            .responsive-table td:first-child::before {
                display: none;
            }
            .responsive-table td[data-label="Links"] .flex {
                justify-content: flex-end;
                flex-grow: 1;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-black text-gray-200">

    <div id="loading-indicator" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg">Cargando datos desde Google Sheets...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Sancta Caecilia</h1>
            <p class="text-gray-400 mt-2">by LFR</p>
        </header>

        <!-- Navegación de Pestañas -->
        <nav class="flex flex-wrap justify-center gap-2 mb-8">
            <button onclick="showTab('por-escuchar-list')" class="tab-button tab-active py-2 px-4 rounded-md font-semibold bg-gray-800 hover:bg-gray-700 transition-colors duration-200 flex items-center">
                Para Escuchar (Lista) <span id="count-pe" class="ml-2 bg-gray-600 text-xs font-semibold px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="showTab('escuchadas-list')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-800 hover:bg-gray-700 transition-colors duration-200 flex items-center">
                Escuchadas (Lista) <span id="count-e" class="ml-2 bg-gray-600 text-xs font-semibold px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="showTab('por-escuchar-random')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-800 hover:bg-gray-700 transition-colors duration-200">Para Escuchar (Random)</button>
            <button onclick="showTab('escuchadas-random')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-800 hover:bg-gray-700 transition-colors duration-200">Escuchadas (Random)</button>
            <button onclick="showTab('global-search-tab')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-800 hover:bg-gray-700 transition-colors duration-200">Búsqueda Global</button>
            <button onclick="showTab('stats-tab')" class="tab-button py-2 px-4 rounded-md font-semibold bg-gray-800 hover:bg-gray-700 transition-colors duration-200">Estadísticas</button>
        </nav>

        <!-- Contenido de las Pestañas -->
        <main>
            <!-- Pestaña 1: Para Escuchar - Lista -->
            <div id="por-escuchar-list" class="tab-content">
                <div class="bg-gray-900 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4">Filtros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <div class="flex flex-col">
                            <label for="filter-pe-artista" class="text-sm font-medium text-gray-400 mb-1">Artista</label>
                            <input type="text" id="filter-pe-artista" placeholder="Artista..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-gray-500 focus:outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-disco" class="text-sm font-medium text-gray-400 mb-1">Disco</label>
                            <input type="text" id="filter-pe-disco" placeholder="Disco..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-gray-500 focus:outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-estilo" class="text-sm font-medium text-gray-400 mb-1">Estilo(s)</label>
                            <select id="filter-pe-estilo" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-pais" class="text-sm font-medium text-gray-400 mb-1">País(es)</label>
                            <select id="filter-pe-pais" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-pe-escuchada" class="text-sm font-medium text-gray-400 mb-1">Ya Escuchada?</label>
                            <select id="filter-pe-escuchada" multiple></select>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-end justify-between mt-4 gap-4">
                        <div class="flex flex-col flex-grow min-w-[200px]">
                            <label for="filter-pe-comentario" class="text-sm font-medium text-gray-400 mb-1">Seleccionar Comentario</label>
                            <select id="filter-pe-comentario" multiple></select>
                        </div>
                        <div class="flex flex-col flex-grow min-w-[200px]">
                            <label for="filter-pe-comentario-text" class="text-sm font-medium text-gray-400 mb-1">Buscar en Comentario</label>
                            <input type="text" id="filter-pe-comentario-text" placeholder="Texto en comentario..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-gray-500 focus:outline-none">
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="clearFilters('porEscuchar')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Limpiar Filtros</button>
                            <button onclick="shuffleList('porEscuchar')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Shuffle Orden</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto bg-gray-900 rounded-lg">
                    <table class="min-w-full text-sm text-left text-gray-300 responsive-table">
                        <thead class="text-xs text-gray-100 uppercase bg-gray-800">
                            <tr>
                                <th class="px-6 py-3">Artista</th>
                                <th class="px-6 py-3">Disco</th>
                                <th class="px-6 py-3">Estilo</th>
                                <th class="px-6 py-3">País</th>
                                <th class="px-6 py-3">Comentario</th>
                                <th class="px-6 py-3">Ya Escuchada?</th>
                                <th class="px-6 py-3">Links</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-por-escuchar"></tbody>
                    </table>
                </div>
                <div id="pagination-pe" class="flex flex-wrap justify-center items-center mt-4 gap-2"></div>
            </div>

            <!-- Pestaña 2: Escuchadas - Lista -->
            <div id="escuchadas-list" class="tab-content" style="display: none;">
                <div class="bg-gray-900 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4">Filtros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col">
                            <label for="filter-e-artista" class="text-sm font-medium text-gray-400 mb-1">Artista</label>
                            <input type="text" id="filter-e-artista" placeholder="Artista..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-gray-500 focus:outline-none">
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-e-estilo" class="text-sm font-medium text-gray-400 mb-1">Estilo(s)</label>
                            <select id="filter-e-estilo" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-e-pais" class="text-sm font-medium text-gray-400 mb-1">País(es)</label>
                            <select id="filter-e-pais" multiple></select>
                        </div>
                        <div class="flex flex-col">
                            <label for="filter-e-seguir" class="text-sm font-medium text-gray-400 mb-1">Seguir Escuchando?</label>
                            <select id="filter-e-seguir" multiple></select>
                        </div>
                    </div>
                     <div class="flex flex-wrap items-end justify-between mt-4 gap-4">
                        <div class="flex flex-col flex-grow min-w-[200px]">
                            <label for="filter-e-comentario" class="text-sm font-medium text-gray-400 mb-1">Comentario</label>
                            <input type="text" id="filter-e-comentario" placeholder="Comentario..." class="bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-gray-500 focus:outline-none">
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="clearFilters('escuchadas')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Limpiar Filtros</button>
                            <button onclick="shuffleList('escuchadas')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Shuffle Orden</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto bg-gray-900 rounded-lg">
                    <table class="min-w-full text-sm text-left text-gray-300 responsive-table">
                        <thead class="text-xs text-gray-100 uppercase bg-gray-800">
                            <tr>
                                <th class="px-6 py-3">Artista</th>
                                <th class="px-6 py-3">Estilo</th>
                                <th class="px-6 py-3">País</th>
                                <th class="px-6 py-3">Comentario</th>
                                <th class="px-6 py-3">Seguir Escuchando?</th>
                                <th class="px-6 py-3">Links</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-escuchadas"></tbody>
                    </table>
                </div>
                 <div id="pagination-e" class="flex flex-wrap justify-center items-center mt-4 gap-2"></div>
            </div>
            
            <!-- Pestaña 3: Para Escuchar - Random -->
            <div id="por-escuchar-random" class="tab-content text-center" style="display: none;">
                <button onclick="showRandom('porEscuchar')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors mb-8">¡Dame un artista para escuchar!</button>
                <div id="random-card-por-escuchar" class="bg-gray-800 rounded-lg p-6 max-w-2xl mx-auto shadow-lg">
                     <p class="text-gray-400">Haz clic en el botón para obtener una recomendación aleatoria.</p>
                </div>
            </div>

            <!-- Pestaña 4: Escuchadas - Random -->
            <div id="escuchadas-random" class="tab-content text-center" style="display: none;">
                <button onclick="showRandom('escuchadas')" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors mb-8">¡Recuérdame un artista que ya escuché!</button>
                <div id="random-card-escuchadas" class="bg-gray-800 rounded-lg p-6 max-w-2xl mx-auto shadow-lg">
                    <p class="text-gray-400">Haz clic en el botón para obtener un recuerdo aleatorio.</p>
                </div>
            </div>
            
            <!-- Pestaña 5: Búsqueda Global -->
            <div id="global-search-tab" class="tab-content" style="display: none;">
                <div class="bg-gray-900 p-4 rounded-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4">Búsqueda Global de Artistas</h3>
                    <input type="text" id="global-search-input" placeholder="Escribe el nombre de un artista..." class="w-full bg-gray-200 border-gray-400 text-gray-900 placeholder-gray-500 rounded-md p-2 h-[42px] focus:ring-2 focus:ring-gray-500 focus:outline-none">
                </div>
                <div id="global-search-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Los resultados de la búsqueda se insertarán aquí -->
                </div>
            </div>

            <!-- Pestaña 6: Estadísticas -->
            <div id="stats-tab" class="tab-content" style="display: none;">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Sección de Países -->
                    <div class="bg-gray-900 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold mb-4 text-center">Artistas por País</h3>
                        <div class="chart-container" style="position: relative; height:40vh; width:100%">
                             <canvas id="country-chart"></canvas>
                        </div>
                        <div id="country-table-container" class="mt-6 max-h-80 overflow-y-auto"></div>
                    </div>
                    <!-- Sección de Estilos -->
                    <div class="bg-gray-900 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold mb-4 text-center">Top 15 Estilos Musicales</h3>
                        <div class="chart-container" style="position: relative; height:40vh; width:100%">
                            <canvas id="style-chart"></canvas>
                        </div>
                        <div id="style-table-container" class="mt-6 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URLs de los Google Sheets publicados como CSV
        const URL_POR_ESCUCHAR = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGpNMHvwKugDUe7EvNvQVIBEBg7RdgHEpcWlUuOQlE5oBF0b61Ql-HN35dWfewWlR7gftloGshufJ-/pub?gid=0&single=true&output=csv';
        const URL_ESCUCHADAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGpNMHvwKugDUe7EvNvQVIBEBg7RdgHEpcWlUuOQlE5oBF0b61Ql-HN35dWfewWlR7gftloGshufJ-/pub?gid=832295915&single=true&output=csv';

        // Almacenamiento de datos
        let porEscucharData = [];
        let escuchadasData = [];
        let filteredPorEscuchar = [];
        let filteredEscuchadas = [];
        
        // Instancias de Tom Select
        let tomSelectsPE = {};
        let tomSelectsE = {};

        // Paginación
        let porEscucharCurrentPage = 1;
        let escuchadasCurrentPage = 1;
        const ROWS_PER_PAGE = 10;

        // Estadísticas
        let countryStats, styleStats;
        let chartsRendered = false;
        let isClearingFilters = false;

        // Nombres de los servicios para los links
        const LINK_NAMES = ["Spotify", "Metal Archives", "RYM", "LastFM", "AOTY", "Music Map", "AllMusic", "Google"];

        // --- INICIALIZACIÓN ---
        window.onload = async () => {
            try {
                const [peData, eData] = await Promise.all([
                    fetchAndParseCSV(URL_POR_ESCUCHAR),
                    fetchAndParseCSV(URL_ESCUCHADAS)
                ]);
                
                const findDataStart = (data) => {
                    let headerIndex = -1;
                    for (let i = 0; i < data.length; i++) {
                        if (data[i] && data[i][1] && data[i][1].trim() === 'Artista') {
                            headerIndex = i;
                        }
                    }
                    return headerIndex === -1 ? 1 : headerIndex + 1;
                };

                const peDataStart = findDataStart(peData);
                const eDataStart = findDataStart(eData);

                porEscucharData = peData.slice(peDataStart).filter(row => row[1] && row[1].trim() !== '');
                escuchadasData = eData.slice(eDataStart).filter(row => row[1] && row[1].trim() !== '');

                // Randomizar el orden inicial
                for (let i = porEscucharData.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [porEscucharData[i], porEscucharData[j]] = [porEscucharData[j], porEscucharData[i]]; }
                for (let i = escuchadasData.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [escuchadasData[i], escuchadasData[j]] = [escuchadasData[j], escuchadasData[i]]; }
                
                filteredPorEscuchar = [...porEscucharData];
                filteredEscuchadas = [...escuchadasData];
                
                updateTabCounts();
                initializeFilters();
                calculateStatistics();
                renderTable('porEscuchar');
                renderTable('escuchadas');

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                alert("Hubo un error al cargar los datos desde Google Sheets. Revisa la consola para más detalles.");
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
            }
        };

        // --- LÓGICA DE DATOS Y FILTROS ---
        async function fetchAndParseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false,
                    complete: (results) => {
                        const cleanData = results.data.filter(row => row.some(cell => cell && cell.trim() !== ''));
                        resolve(cleanData);
                    },
                    error: (error) => reject(error)
                });
            });
        }

        function initializeFilters() {
            const tomSelectConfig = (placeholder, checkbox = true) => ({ 
                plugins: checkbox ? ['checkbox_options', 'remove_button'] : ['remove_button'],
                placeholder: placeholder,
                hidePlaceholder: true,
                persist: false,
                create: false
            });

            // --- Filtros "Para Escuchar" ---
            const peEstilos = [...new Set(porEscucharData.map(row => row[3]).filter(Boolean))].sort().map(val => ({value: val, text: val}));
            const pePaises = [...new Set(porEscucharData.map(row => row[4]).filter(Boolean))].sort().map(val => ({value: val, text: val}));
            const peComentarios = [...new Set(porEscucharData.map(row => row[5]).filter(Boolean))].sort().map(val => ({value: val, text: val}));
            const peEscuchadaOpts = [...new Set(porEscucharData.map(row => row[6]).filter(Boolean))].sort().map(val => ({value: val, text: val}));
            
            tomSelectsPE.estilo = new TomSelect('#filter-pe-estilo', tomSelectConfig('Estilo(s)...'));
            tomSelectsPE.estilo.addOptions(peEstilos);
            
            tomSelectsPE.pais = new TomSelect('#filter-pe-pais', tomSelectConfig('País(es)...'));
            tomSelectsPE.pais.addOptions(pePaises);

            tomSelectsPE.comentario = new TomSelect('#filter-pe-comentario', tomSelectConfig('Comentario(s)...'));
            tomSelectsPE.comentario.addOptions(peComentarios);

            tomSelectsPE.escuchada = new TomSelect('#filter-pe-escuchada', tomSelectConfig('Ya Escuchada?'));
            tomSelectsPE.escuchada.addOptions(peEscuchadaOpts);
            
            document.getElementById('filter-pe-artista').addEventListener('input', () => applyFilters('porEscuchar'));
            document.getElementById('filter-pe-disco').addEventListener('input', () => applyFilters('porEscuchar'));
            document.getElementById('filter-pe-comentario-text').addEventListener('input', () => applyFilters('porEscuchar'));
            tomSelectsPE.estilo.on('change', () => { if (!isClearingFilters) applyFilters('porEscuchar'); });
            tomSelectsPE.pais.on('change', () => { if (!isClearingFilters) applyFilters('porEscuchar'); });
            tomSelectsPE.comentario.on('change', () => { if (!isClearingFilters) applyFilters('porEscuchar'); });
            tomSelectsPE.escuchada.on('change', () => { if (!isClearingFilters) applyFilters('porEscuchar'); });

            // --- Filtros "Escuchadas" ---
            const eEstilos = [...new Set(escuchadasData.map(row => row[2]).filter(Boolean))].sort().map(val => ({value: val, text: val}));
            const ePaises = [...new Set(escuchadasData.map(row => row[3]).filter(Boolean))].sort().map(val => ({value: val, text: val}));
            const eSeguirOpts = [...new Set(escuchadasData.map(row => row[5]).filter(Boolean))].sort().map(val => ({value: val, text: val}));
            
            tomSelectsE.estilo = new TomSelect('#filter-e-estilo', tomSelectConfig('Estilo(s)...'));
            tomSelectsE.estilo.addOptions(eEstilos);
            
            tomSelectsE.pais = new TomSelect('#filter-e-pais', tomSelectConfig('País(es)...'));
            tomSelectsE.pais.addOptions(ePaises);
            
            tomSelectsE.seguir = new TomSelect('#filter-e-seguir', tomSelectConfig('Seguir Escuchando?'));
            tomSelectsE.seguir.addOptions(eSeguirOpts);
            
            document.getElementById('filter-e-artista').addEventListener('input', () => applyFilters('escuchadas'));
            document.getElementById('filter-e-comentario').addEventListener('input', () => applyFilters('escuchadas'));
            tomSelectsE.estilo.on('change', () => { if (!isClearingFilters) applyFilters('escuchadas'); });
            tomSelectsE.pais.on('change', () => { if (!isClearingFilters) applyFilters('escuchadas'); });
            tomSelectsE.seguir.on('change', () => { if (!isClearingFilters) applyFilters('escuchadas'); });
            
            // --- Búsqueda Global ---
            document.getElementById('global-search-input').addEventListener('input', performGlobalSearch);
        }

        function clearFilters(type) {
            isClearingFilters = true;
            if (type === 'porEscuchar') {
                document.getElementById('filter-pe-artista').value = '';
                document.getElementById('filter-pe-disco').value = '';
                document.getElementById('filter-pe-comentario-text').value = '';
                tomSelectsPE.estilo.clear();
                tomSelectsPE.pais.clear();
                tomSelectsPE.comentario.clear();
                tomSelectsPE.escuchada.clear();
            } else { // escuchadas
                document.getElementById('filter-e-artista').value = '';
                document.getElementById('filter-e-comentario').value = '';
                tomSelectsE.estilo.clear();
                tomSelectsE.pais.clear();
                tomSelectsE.seguir.clear();
            }
            isClearingFilters = false;
            applyFilters(type);
        }

        function applyFilters(type) {
            if (type === 'porEscuchar') {
                const artista = document.getElementById('filter-pe-artista').value.toLowerCase();
                const disco = document.getElementById('filter-pe-disco').value.toLowerCase();
                const estilos = tomSelectsPE.estilo.getValue();
                const paises = tomSelectsPE.pais.getValue();
                const comentarios = tomSelectsPE.comentario.getValue();
                const comentarioText = document.getElementById('filter-pe-comentario-text').value.toLowerCase();
                const searchWordsPE = comentarioText.split(' ').filter(w => w.length > 0);
                const escuchadas = tomSelectsPE.escuchada.getValue();
                filteredPorEscuchar = porEscucharData.filter(row => {
                    const commentText = (row[5] || '').toLowerCase();
                    const matchComentarioText = searchWordsPE.length === 0 || searchWordsPE.every(word => commentText.includes(word));

                    return (row[1] || '').toLowerCase().includes(artista) &&
                           (row[2] || '').toLowerCase().includes(disco) &&
                           (estilos.length === 0 || estilos.includes(row[3] || '')) &&
                           (paises.length === 0 || paises.includes(row[4] || '')) &&
                           (comentarios.length === 0 || comentarios.includes(row[5] || '')) &&
                           matchComentarioText &&
                           (escuchadas.length === 0 || escuchadas.includes(row[6] || ''));
                });
                porEscucharCurrentPage = 1;
                renderTable('porEscuchar');
            } else {
                const artista = document.getElementById('filter-e-artista').value.toLowerCase();
                const estilos = tomSelectsE.estilo.getValue();
                const paises = tomSelectsE.pais.getValue();
                const comentario = document.getElementById('filter-e-comentario').value.toLowerCase();
                const searchWordsE = comentario.split(' ').filter(w => w.length > 0);
                const seguir = tomSelectsE.seguir.getValue();
                filteredEscuchadas = escuchadasData.filter(row => {
                    const commentText = (row[4] || '').toLowerCase();
                    const matchComentario = searchWordsE.length === 0 || searchWordsE.every(word => commentText.includes(word));

                    return (row[1] || '').toLowerCase().includes(artista) &&
                           (estilos.length === 0 || estilos.includes(row[2] || '')) &&
                           (paises.length === 0 || paises.includes(row[3] || '')) &&
                           matchComentario &&
                           (seguir.length === 0 || seguir.includes(row[5] || ''));
                });
                escuchadasCurrentPage = 1;
                renderTable('escuchadas');
            }
        }

        // --- LÓGICA DE LA INTERFAZ (UI) ---
        function updateTabCounts() {
            document.getElementById('count-pe').textContent = porEscucharData.length;
            document.getElementById('count-e').textContent = escuchadasData.length;
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('tab-active'));
            document.getElementById(tabId).style.display = 'block';
            const activeButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.getAttribute('onclick') === `showTab('${tabId}')`);
            if (activeButton) activeButton.classList.add('tab-active');
            
            if (tabId === 'stats-tab' && !chartsRendered) {
                renderCountryChart();
                renderStyleChart();
                chartsRendered = true;
            }
        }

        function renderTable(type) {
            const tableBodyId = type === 'porEscuchar' ? 'table-body-por-escuchar' : 'table-body-escuchadas';
            const tableBody = document.getElementById(tableBodyId);
            const data = type === 'porEscuchar' ? filteredPorEscuchar : filteredEscuchadas;
            const currentPage = type === 'porEscuchar' ? porEscucharCurrentPage : escuchadasCurrentPage;
            tableBody.innerHTML = ''; 

            if (!data || data.length === 0) {
                const colSpan = type === 'porEscuchar' ? 7 : 6;
                tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4">No se encontraron resultados para los filtros aplicados.</td></tr>`;
                renderPaginationControls(type);
                return;
            }
            
            const paginatedData = data.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
            paginatedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'bg-gray-900 border-b border-gray-800';
                if (type === 'porEscuchar') {
                    tr.innerHTML = `
                        <td data-label="Artista" class="px-6 py-2 font-medium text-white whitespace-nowrap">${row[1] || ''}</td>
                        <td data-label="Disco" class="px-6 py-2">${row[2] || ''}</td>
                        <td data-label="Estilo" class="px-6 py-2">${row[3] || ''}</td>
                        <td data-label="País" class="px-6 py-2">${row[4] || ''}</td>
                        <td data-label="Comentario" class="px-6 py-2">${row[5] || ''}</td>
                        <td data-label="Ya Escuchada?" class="px-6 py-2">${row[6] || ''}</td>
                        <td data-label="Links" class="px-6 py-2">${generateLinksHtml(row, 7, 14)}</td>`;
                } else {
                    tr.innerHTML = `
                        <td data-label="Artista" class="px-6 py-2 font-medium text-white whitespace-nowrap">${row[1] || ''}</td>
                        <td data-label="Estilo" class="px-6 py-2">${row[2] || ''}</td>
                        <td data-label="País" class="px-6 py-2">${row[3] || ''}</td>
                        <td data-label="Comentario" class="px-6 py-2">${row[4] || ''}</td>
                        <td data-label="Seguir Escuchando?" class="px-6 py-2">${row[5] || ''}</td>
                        <td data-label="Links" class="px-6 py-2">${generateLinksHtml(row, 6, 13)}</td>`;
                }
                tableBody.appendChild(tr);
            });
            renderPaginationControls(type);
        }
        
        function renderPaginationControls(type) {
            const containerId = type === 'porEscuchar' ? 'pagination-pe' : 'pagination-e';
            const container = document.getElementById(containerId);
            const data = type === 'porEscuchar' ? filteredPorEscuchar : filteredEscuchadas;
            let currentPage = type === 'porEscuchar' ? porEscucharCurrentPage : escuchadasCurrentPage;
            const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);

            container.innerHTML = '';
            if (totalPages <= 1) return;
            
            const btnClass = "pagination-button px-3 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed";
            container.innerHTML = `<div class="flex items-center justify-center gap-2">
                <button onclick="changePage('${type}', 1)" class="${btnClass}" ${currentPage === 1 ? 'disabled' : ''}>Inicio</button>
                <button onclick="changePage('${type}', ${currentPage - 1})" class="${btnClass}" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>
                <span class="text-sm text-gray-400">Página</span>
                <input type="number" value="${currentPage}" onchange="goToPage('${type}', this.value, ${totalPages})" min="1" max="${totalPages}" class="w-16 bg-gray-700 text-center rounded-md p-2 focus:ring-2 focus:ring-gray-500 focus:outline-none">
                <span class="text-sm text-gray-400">de ${totalPages}</span>
                <button onclick="changePage('${type}', ${currentPage + 1})" class="${btnClass}" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente</button>
                <button onclick="changePage('${type}', ${totalPages})" class="${btnClass}" ${currentPage === totalPages ? 'disabled' : ''}>Final</button>
            </div>`;
        }

        function changePage(type, page) {
            const data = type === 'porEscuchar' ? filteredPorEscuchar : filteredEscuchadas;
            const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);
            const newPage = Math.max(1, Math.min(page, totalPages));
            if (type === 'porEscuchar') porEscucharCurrentPage = newPage;
            else escuchadasCurrentPage = newPage;
            renderTable(type);
        }
        
        function goToPage(type, pageStr, totalPages) {
            let page = parseInt(pageStr, 10);
            if (isNaN(page) || page < 1) page = 1;
            else if (page > totalPages) page = totalPages;
            changePage(type, page);
        }

        function generateLinksHtml(row, startIdx, endIdx) {
            let linksHtml = '<div class="flex flex-wrap gap-2">';
            for (let i = startIdx; i <= endIdx; i++) {
                const url = row[i];
                const name = LINK_NAMES[i - startIdx];
                if (url && url.startsWith('http')) {
                    let finalUrl = url;
                    let target = '_blank';
                    if (name === "Spotify" && url.includes('open.spotify.com')) {
                        finalUrl = url.replace('https://open.spotify.com/', 'spotify:');
                        target = '_self';
                    }
                    linksHtml += `<a href="${finalUrl}" target="${target}" rel="noopener noreferrer" class="text-xs bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-2 rounded-full transition-colors">${name}</a>`;
                }
            }
            return linksHtml + '</div>';
        }
        
        function shuffleList(type) {
            const data = type === 'porEscuchar' ? filteredPorEscuchar : filteredEscuchadas;
            for (let i = data.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [data[i], data[j]] = [data[j], data[i]];
            }
            if (type === 'porEscuchar') porEscucharCurrentPage = 1;
            else escuchadasCurrentPage = 1;
            renderTable(type);
        }
        
        // --- BÚSQUEDA GLOBAL ---
        function performGlobalSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('global-search-results');
            resultsContainer.innerHTML = '';

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">Escribe al menos 2 caracteres para buscar.</p>';
                return;
            }

            const foundInPE = porEscucharData
                .filter(row => (row[1] || '').toLowerCase().includes(searchTerm))
                .map(row => ({ data: row, source: 'Para Escuchar' }));

            const foundInE = escuchadasData
                .filter(row => (row[1] || '').toLowerCase().includes(searchTerm))
                .map(row => ({ data: row, source: 'Escuchadas' }));

            const allResults = [...foundInPE, ...foundInE];

            if (allResults.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">No se encontraron artistas con ese nombre.</p>';
                return;
            }

            allResults.forEach(result => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg p-4 flex flex-col justify-between';
                let content = '';
                if (result.source === 'Para Escuchar') {
                    content = `
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="text-lg font-bold text-white">${result.data[1]}</h4>
                                    <p class="text-sm text-gray-300">${result.data[2] || ''}</p>
                                </div>
                                <span class="text-xs bg-blue-600 text-white font-semibold px-2 py-1 rounded-full whitespace-nowrap">${result.source}</span>
                            </div>
                            <div class="text-sm space-y-1 text-gray-400">
                                <p><strong class="font-semibold text-gray-500">Estilo:</strong> ${result.data[3] || 'N/A'}</p>
                                <p><strong class="font-semibold text-gray-500">País:</strong> ${result.data[4] || 'N/A'}</p>
                                <p><strong class="font-semibold text-gray-500">Comentario:</strong> ${result.data[5] || 'N/A'}</p>
                                <p><strong class="font-semibold text-gray-500">Ya Escuchada?:</strong> ${result.data[6] || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            ${generateLinksHtml(result.data, 7, 14)}
                        </div>
                    `;
                } else { // Escuchadas
                    content = `
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                 <h4 class="text-lg font-bold text-white">${result.data[1]}</h4>
                                <span class="text-xs bg-green-600 text-white font-semibold px-2 py-1 rounded-full whitespace-nowrap">${result.source}</span>
                            </div>
                            <div class="text-sm space-y-1 text-gray-400">
                                <p><strong class="font-semibold text-gray-500">Estilo:</strong> ${result.data[2] || 'N/A'}</p>
                                <p><strong class="font-semibold text-gray-500">País:</strong> ${result.data[3] || 'N/A'}</p>
                                <p><strong class="font-semibold text-gray-500">Comentario:</strong> ${result.data[4] || 'N/A'}</p>
                                <p><strong class="font-semibold text-gray-500">Seguir Escuchando?:</strong> ${result.data[5] || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            ${generateLinksHtml(result.data, 6, 13)}
                        </div>
                    `;
                }
                card.innerHTML = content;
                resultsContainer.appendChild(card);
            });
        }


        // --- LÓGICA DE ESTADÍSTICAS ---
        function calculateStatistics() {
            const allData = [
                ...porEscucharData.map(row => ({ style: row[3], country: row[4] })),
                ...escuchadasData.map(row => ({ style: row[2], country: row[3] }))
            ];

            const countItems = (key) => {
                const counts = allData.reduce((acc, item) => {
                    const value = item[key];
                    if (value) {
                        acc[value] = (acc[value] || 0) + 1;
                    }
                    return acc;
                }, {});
                return Object.entries(counts).map(([name, count]) => ({ name, count })).sort((a, b) => b.count - a.count);
            };

            countryStats = countItems('country');
            styleStats = countItems('style');
        }

        function renderStatsTable(containerId, headers, data) {
            const container = document.getElementById(containerId);
            let table = `<table class="min-w-full text-sm text-left text-gray-300">
                <thead class="text-xs text-gray-100 uppercase bg-gray-800">
                    <tr>${headers.map(h => `<th class="px-6 py-3">${h}</th>`).join('')}</tr>
                </thead><tbody>`;
            data.forEach(item => {
                table += `<tr class="bg-gray-900 border-b border-gray-800">
                    <td class="px-6 py-2">${item.name}</td>
                    <td class="px-6 py-2">${item.count}</td>
                </tr>`;
            });
            table += `</tbody></table>`;
            container.innerHTML = table;
        }

        function renderCountryChart() {
            const ctx = document.getElementById('country-chart').getContext('2d');
            const top10Countries = countryStats.slice(0, 10);
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: top10Countries.map(c => c.name),
                    datasets: [{
                        label: 'Artistas por País',
                        data: top10Countries.map(c => c.count),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'],
                        borderColor: '#111827',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } }
            });
            renderStatsTable('country-table-container', ['País', 'Cantidad'], countryStats);
        }

        function renderStyleChart() {
            const ctx = document.getElementById('style-chart').getContext('2d');
            const top15Styles = styleStats.slice(0, 15);
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top15Styles.map(s => s.name),
                    datasets: [{
                        label: 'Cantidad de Artistas',
                        data: top15Styles.map(s => s.count),
                        backgroundColor: '#4b5563',
                        borderColor: '#6b7280',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } }
                    }
                }
            });
            renderStatsTable('style-table-container', ['Estilo', 'Cantidad'], styleStats);
        }

        // --- LÓGICA RANDOM ---
        function showRandom(type) {
            const data = type === 'porEscuchar' ? porEscucharData : escuchadasData;
            const cardContainerId = type === 'porEscuchar' ? 'random-card-por-escuchar' : 'random-card-escuchadas';
            const cardContainer = document.getElementById(cardContainerId);

            if (!data || data.length === 0) {
                cardContainer.innerHTML = '<p class="text-red-400">No hay datos disponibles para mostrar.</p>';
                return;
            }

            const randomIndex = Math.floor(Math.random() * data.length);
            const randomRow = data[randomIndex];
            cardContainer.innerHTML = ''; 
            
            let cardHtml = '';
            if (type === 'porEscuchar') {
                const linksHtml = generateLinksHtml(randomRow, 7, 14);
                cardHtml = `
                    <div class="text-left">
                        <div class="bg-gray-700 p-3 text-center rounded-t-lg">
                            <h2 class="text-xl font-bold text-white">${randomRow[1] || 'Sin Artista'}</h2>
                        </div>
                        <div class="divide-y divide-gray-700">
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">Disco:</strong> <span>${randomRow[2] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">Estilo:</strong> <span>${randomRow[3] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">País:</strong> <span>${randomRow[4] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">Comentario:</strong> <span>${randomRow[5] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">Ya Escuchada?:</strong> <span>${randomRow[6] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between items-center"><strong class="font-semibold text-gray-400 mr-4">Enlaces:</strong> <div class="flex-grow flex justify-end">${linksHtml}</div></div>
                        </div>
                    </div>`;
            } else {
                const linksHtml = generateLinksHtml(randomRow, 6, 13);
                cardHtml = `
                    <div class="text-left">
                        <div class="bg-gray-700 p-3 text-center rounded-t-lg">
                            <h2 class="text-xl font-bold text-white">${randomRow[1] || 'Sin Artista'}</h2>
                        </div>
                        <div class="divide-y divide-gray-700">
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">Estilo:</strong> <span>${randomRow[2] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">País:</strong> <span>${randomRow[3] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">Comentario:</strong> <span>${randomRow[4] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between"><strong class="font-semibold text-gray-400 mr-4">Seguir Escuchando?:</strong> <span>${randomRow[5] || 'N/A'}</span></div>
                            <div class="p-3 flex justify-between items-center"><strong class="font-semibold text-gray-400 mr-4">Enlaces:</strong> <div class="flex-grow flex justify-end">${linksHtml}</div></div>
                        </div>
                    </div>`;
            }
            cardContainer.innerHTML = cardHtml;
        }
    </script>
</body>
</html>
